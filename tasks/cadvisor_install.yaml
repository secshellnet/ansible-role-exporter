---
- name: Install pip3
  ansible.builtin.apt:
    name:
      - python3-pip
    state: present

- name: Install several required python modules
  ansible.builtin.pip:
    name: [requests, docker, docker-compose]

- name: Create cadvisor service directory
  ansible.builtin.file:
    path: /home/admin/cadvisor/
    state: directory
    mode: '0775'
    owner: root
    group: admin

- name: Check if cadvisor compose already exists
  ansible.builtin.stat:
    path: /home/admin/cadvisor/docker-compose.yml
  register: cadvisor_exists

# TODO can't handle changes... find another solution
#- name: Check whether the local file is equal to the remote file
#  ansible.builtin.template:
#    src: docker-compose.yml
#    dest: /home/admin/cadvisor/docker-compose.yml
#    diff_mode: true
#    check_mode: true
#  when: cadvisor_exists.stat.exists
#  register: cadvisor_file

# TODO check diff between local and remote, if not the same: upload local to remote
# alternative: give container_name argument and remove container using docker if file has been replaced

# TODO @schnitzel
# - name: Silence Monitoring for one minute
#   when: cadvisor_exists.stat.exists and cadvisor_file.changed

# docker-compose -f /home/admin/cadvisor/docker-compose.yml down
- name: Stop and remove cadvisor container
  community.docker.docker_compose:
    project_src: /home/admin/cadvisor/
    state: absent
  when: cadvisor_exists.stat.exists and cadvisor_file.changed

- name: Create cadvisor docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml
    dest: /home/admin/cadvisor/docker-compose.yml
    owner: root
    group: admin
    mode: '0664'
  register: cadvisor_file_new

# docker-compose -f /home/admin/cadvisor/docker-compose.yml up -d
- name: Create and start cadvisor container
  community.docker.docker_compose:
    project_src: /home/admin/cadvisor/
  when: cadvisor_file and cadvisor_file_new